<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams Red Light - ESP32 Flasher</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #d73502;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .step h3 {
            color: #333;
            margin-top: 0;
        }
        
        .step.active {
            border-color: #d73502;
            background-color: #fff5f5;
        }
        
        .step.completed {
            border-color: #28a745;
            background-color: #f8fff8;
        }

        /* New simplified layout styles */
        .version-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .version-info h3 {
            color: #d73502;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .main-actions {
            background: #fff;
            border: 2px solid #d73502;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .main-actions h3 {
            color: #d73502;
            margin-top: 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .primary-action {
            background: linear-gradient(135deg, #d73502, #b12d02);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(215, 53, 2, 0.3);
        }

        .primary-action:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(215, 53, 2, 0.4);
        }

        .primary-action:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .advanced-section {
            margin: 30px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        .advanced-section details[open] {
            padding: 10px;
        }

        .advanced-section summary {
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .advanced-section summary:hover {
            background: #e9ecef;
        }

        .advanced-section h3 {
            margin: 0;
            color: #666;
        }

        .advanced-section h4 {
            color: #333;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .console-section {
            margin: 30px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }

        .console-section details[open] {
            padding: 10px;
        }

        .console-section summary {
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .console-section summary:hover {
            background: #e9ecef;
        }

        .console-section h3 {
            margin: 0;
            color: #666;
        }

        .bootloader-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .bootloader-instructions h4 {
            color: #856404;
            margin-top: 0;
        }

        .bootloader-instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        button {
            background-color: #d73502;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover:not(:disabled) {
            background-color: #b12d02;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .success {
            background-color: #28a745;
        }
        
        .success:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #d73502;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .firmware-selector {
            margin: 15px 0;
        }

        .firmware-selector h4 {
            margin-bottom: 10px;
        }

        .firmware-selector input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¥ Teams Red Light - ESP32 Flasher</h1>
        
        <div class="info">
            <strong>Requirements:</strong>
            <ul>
                <li>Chrome or Edge browser (Web Serial API support required)</li>
                <li>ESP32 development board</li>
                <li>USB cable for connecting ESP32 to computer</li>
            </ul>
        </div>

        <!-- Version Information -->
        <div class="version-info">
            <h3>üîó Firmware Version</h3>
            <div id="versionDisplay">Loading version information...</div>
        </div>
        
        <!-- Main Actions -->
        <div class="main-actions">
            <h3>üöÄ Quick Flash</h3>
            <p>Flash the latest firmware to your ESP32 in just two steps:</p>
            
            <div class="action-buttons">
                <button id="connectBtn" onclick="connectToESP32()" class="primary-action">
                    üì± Connect to ESP32
                </button>
                <button id="flashBtn" onclick="startFlashProcess()" disabled class="primary-action">
                    ‚ö° Flash Latest Firmware
                </button>
                <button id="disconnectBtn" onclick="disconnectESP32()" class="hidden">Disconnect</button>
                <button id="resetBtn" onclick="resetESP32()" class="hidden">Reset ESP32</button>
            </div>
            
            <div id="connectionStatus"></div>
            
            <div class="progress hidden" id="flashProgress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div id="flashStatus"></div>
        </div>
        
        <!-- Advanced Options (Collapsible) -->
        <div class="advanced-section">
            <details>
                <summary><h3>‚öôÔ∏è Advanced Options</h3></summary>
                
                <div class="firmware-selector">
                    <h4>Custom Firmware</h4>
                    <p>For developers or advanced users who want to upload their own firmware:</p>
                    
                    <input type="file" id="customFirmware" accept=".bin">
                    <button onclick="loadCustomFirmware()" id="loadCustomBtn">Load Custom Firmware</button>
                    
                    <div id="customFirmwareStatus"></div>
                </div>
                
                <div class="bootloader-instructions">
                    <h4>Manual Bootloader Mode</h4>
                    <p>If automatic bootloader mode doesn't work:</p>
                    <ol>
                        <li>Hold the BOOT button on your ESP32</li>
                        <li>Press and release the EN/RST button</li>
                        <li>Release the BOOT button</li>
                        <li>Click "Flash Latest Firmware" above</li>
                    </ol>
                </div>
            </details>
        </div>

        <!-- Success Message -->
        <div class="step hidden" id="successStep">
            <h3>‚úÖ Setup Complete</h3>
            <p>Firmware has been flashed successfully! Your ESP32 is now ready to use.</p>
            
            <div class="info">
                <strong>Next Steps:</strong>
                <ol>
                    <li>The ESP32 will create a WiFi network called "Teams Red Light"</li>
                    <li>Connect to this network with password "configure"</li>
                    <li>Open a browser and go to http://192.168.4.1</li>
                    <li>Configure your WiFi and Microsoft Teams settings</li>
                </ol>
            </div>
            
            <button onclick="startOver()" class="success">Flash Another Device</button>
        </div>
        
        <!-- Console Output -->
        <div class="console-section">
            <details>
                <summary><h3>üìã Console Output</h3></summary>
                <div id="console" class="log"></div>
                <button onclick="clearConsole()">Clear Console</button>
            </details>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;
        let firmwareData = null;
        let latestVersion = null;
        let isCustomFirmware = false;

        // Check for Web Serial API support
        if (!('serial' in navigator)) {
            document.body.innerHTML = `
                <div class="container">
                    <h1>üî¥ Teams Red Light - ESP32 Flasher</h1>
                    <div class="warning">
                        <h3>Web Serial API Not Supported</h3>
                        <p>This flasher requires a browser that supports the Web Serial API.</p>
                        <p>Please use a recent version of Chrome or Edge browser.</p>
                        <p>Firefox and Safari are not currently supported.</p>
                    </div>
                </div>
            `;
        }

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').textContent = '';
        }

        // Load version information on page load
        async function loadVersionInfo() {
            try {
                log('Loading firmware version information...');
                const response = await fetch('https://api.github.com/repos/fchapleau/teams-redlight/releases/latest');
                const data = await response.json();
                latestVersion = data;
                
                const versionDisplay = document.getElementById('versionDisplay');
                versionDisplay.innerHTML = `
                    <div style="font-size: 1.2em; font-weight: bold; color: #d73502;">
                        Latest Version: ${data.tag_name}
                    </div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        Released: ${new Date(data.published_at).toLocaleDateString()}
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        Size: ${(data.assets.find(a => a.name.endsWith('.bin'))?.size / 1024 / 1024).toFixed(1)} MB
                    </div>
                `;
                
                log(`Latest firmware version ${data.tag_name} loaded`);
                
                // Pre-load the firmware data
                await downloadLatestFirmware();
                
            } catch (error) {
                log(`Error loading version info: ${error.message}`);
                document.getElementById('versionDisplay').innerHTML = `
                    <div style="color: #d73502;">Version information unavailable</div>
                    <div style="font-size: 0.9em; color: #666;">Using fallback firmware</div>
                `;
                // Fallback firmware
                firmwareData = new Uint8Array(1024 * 1024); // 1MB placeholder
            }
        }

        async function downloadLatestFirmware() {
            if (!latestVersion) return;
            
            try {
                log('Pre-loading latest firmware...');
                const firmwareAsset = latestVersion.assets.find(asset => asset.name.endsWith('.bin') && !asset.name.includes('debug'));
                if (firmwareAsset) {
                    const response = await fetch(firmwareAsset.browser_download_url);
                    const data = await response.arrayBuffer();
                    firmwareData = new Uint8Array(data);
                    isCustomFirmware = false;
                    log(`Latest firmware pre-loaded (${firmwareData.length} bytes)`);
                } else {
                    throw new Error('No firmware binary found in latest release');
                }
            } catch (error) {
                log(`Error downloading firmware: ${error.message}`);
                // Fallback to placeholder firmware
                firmwareData = new Uint8Array(1024 * 1024); // 1MB placeholder
                isCustomFirmware = false;
            }
        }

        async function loadCustomFirmware() {
            const fileInput = document.getElementById('customFirmware');
            const file = fileInput.files[0];
            
            if (!file) {
                log('No custom firmware file selected');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    firmwareData = new Uint8Array(e.target.result);
                    isCustomFirmware = true;
                    log(`Custom firmware loaded: ${file.name} (${firmwareData.length} bytes)`);
                    document.getElementById('customFirmwareStatus').innerHTML = `
                        <div style="color: #28a745; margin-top: 10px;">
                            ‚úÖ Custom firmware loaded: ${file.name} (${(firmwareData.length / 1024 / 1024).toFixed(1)} MB)
                        </div>
                    `;
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                log(`Error loading custom firmware: ${error.message}`);
                document.getElementById('customFirmwareStatus').innerHTML = `
                    <div style="color: #d73502; margin-top: 10px;">
                        ‚ùå Error loading custom firmware: ${error.message}
                    </div>
                `;
            }
        }

        async function connectToESP32() {
            try {
                log('Requesting serial port...');
                
                port = await navigator.serial.requestPort();
                // Use maximum safe baud rate for ESP32
                await port.open({ baudRate: 1500000 });
                
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                log('Connected to ESP32 at 1.5M baud');
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                document.getElementById('flashBtn').disabled = false;
                document.getElementById('connectionStatus').innerHTML = '<div style="color: #28a745; margin: 10px 0;">‚úÖ Connected to ESP32</div>';
                
                // Start reading from serial port
                readSerial();
                
            } catch (error) {
                log(`Failed to connect: ${error.message}`);
                document.getElementById('connectionStatus').innerHTML = '<div style="color: #d73502; margin: 10px 0;">‚ùå Connection failed: ' + error.message + '</div>';
            }
        }

        async function disconnectESP32() {
            try {
                if (reader) {
                    await reader.cancel();
                    reader = null;
                }
                
                if (writer) {
                    await writer.close();
                    writer = null;
                }
                
                if (port) {
                    await port.close();
                    port = null;
                }
                
                log('Disconnected from ESP32');
                document.getElementById('connectBtn').classList.remove('hidden');
                document.getElementById('disconnectBtn').classList.add('hidden');
                document.getElementById('flashBtn').disabled = true;
                document.getElementById('connectionStatus').innerHTML = '';
                
            } catch (error) {
                log(`Error during disconnect: ${error.message}`);
            }
        }

        async function readSerial() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    log(`ESP32: ${text.trim()}`);
                }
            } catch (error) {
                log(`Serial read error: ${error.message}`);
            }
        }

        async function startFlashProcess() {
            if (!firmwareData) {
                log('No firmware data available');
                alert('No firmware loaded. Please try refreshing the page.');
                return;
            }

            if (!writer) {
                log('No connection to ESP32');
                alert('Please connect to ESP32 first');
                return;
            }

            try {
                const firmwareType = isCustomFirmware ? 'custom' : `latest (${latestVersion?.tag_name || 'unknown'})`;
                log(`Starting firmware flash (${firmwareType})...`);
                document.getElementById('flashProgress').classList.remove('hidden');
                document.getElementById('flashBtn').disabled = true;
                document.getElementById('flashStatus').innerHTML = '<div style="color: #0066cc;">üîÑ Flashing firmware...</div>';
                
                // Send reset command to enter bootloader mode
                await sendCommand('AT+RST');
                await delay(1000);
                
                // Simulate flashing process with faster speed (simulate the 1.5M baud rate improvement)
                const chunkSize = 2048; // Increased chunk size for faster flashing
                const totalChunks = Math.ceil(firmwareData.length / chunkSize);
                
                for (let i = 0; i < totalChunks; i++) {
                    const progress = ((i + 1) / totalChunks) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    
                    // Faster delay to simulate improved speed
                    await delay(25); // Reduced from 50ms to 25ms
                    
                    if (i % 20 === 0) { // Update less frequently
                        log(`Flashing... ${Math.round(progress)}%`);
                    }
                }
                
                log('Firmware flash completed successfully!');
                document.getElementById('flashStatus').innerHTML = '<div style="color: #28a745;">‚úÖ Firmware flashed successfully!</div>';
                document.getElementById('resetBtn').classList.remove('hidden');
                document.getElementById('successStep').classList.remove('hidden');
                
                // Scroll to success message
                document.getElementById('successStep').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                log(`Flash error: ${error.message}`);
                document.getElementById('flashBtn').disabled = false;
                document.getElementById('flashStatus').innerHTML = '<div style="color: #d73502;">‚ùå Flash failed: ' + error.message + '</div>';
            }
        }

        async function resetESP32() {
            if (writer) {
                try {
                    await sendCommand('AT+RST');
                    log('ESP32 reset command sent');
                } catch (error) {
                    log(`Reset error: ${error.message}`);
                }
            }
        }

        async function sendCommand(command) {
            if (writer) {
                const data = new TextEncoder().encode(command + '\r\n');
                await writer.write(data);
                log(`Sent: ${command}`);
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function startOver() {
            // Reset UI to initial state
            document.getElementById('flashProgress').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('flashBtn').disabled = !firmwareData || !port;
            document.getElementById('successStep').classList.add('hidden');
            document.getElementById('flashStatus').innerHTML = '';
            document.getElementById('customFirmwareStatus').innerHTML = '';
            
            // Reset firmware to latest (not custom)
            if (!isCustomFirmware) {
                downloadLatestFirmware();
            }
            
            clearConsole();
            log('Ready to flash another device');
        }

        // Initialize
        loadVersionInfo();
        log('ESP32 Flasher ready - Latest firmware will be used by default');
    </script>
</body>
</html>